(* 
	framework_test.8th
 
  Integration test for framework
 
 Copyright C 2018 by G3UKB Bob Cowdery
 This program is free software; you can redistribute it and/or modify
 it under the terms of the GNU General Public License as published by
 the Free Software Foundation; either version 2 of the License, or
 at your option any later version.
 
  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  GNU General Public License for more details.
 
  You should have received a copy of the GNU General Public License
  along with this program; if not, write to the Free Software
  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
 
  The author can be reached by email at:   
     bob@bobcowdery.plus.com
*)

\ Includes
"param_st.8th"  f:include
"task_man.8th"  f:include
"struct_manip.8th"  f:include
"registrations.8th" f:include
"pub_sub.8th"  f:include

\ Set namespace to avoid prefixing for the test
ns: fr

\ Push data into different tasks using struct_manip to dice data and store values and use param store as required
\ Init the param store
param_st_alloc
\ Init publish subscribe service
pubsub_init
2 sleep

\ Test structures
{
	"general" : {
	\	key						src			index/val 	SoD			option list			
		"smplrate" : 	[false, [0, 				false, 	["48000", "96000", "192000"]]],
		"numrx" : 		[false, [0, 				false, 	["1", "2", "3"]]],
		"blksz" : 		[false, [1, 				false, 	["512", "1024", "2048", "4096"]]],
		"duplex" : 		[false, [false, 		false, 	[]]],
		"enabletx" : 	[false, [false, 		false, 	[]]]
	}
} var, struct

{
		\ HPSDR Protocol-1 only supports 3 radios
		\ More can be added into the array as required
		"radio-state" : [
			[
				\ src						SoD
				false, [null, false, 
				{
					"display-width": 0,
					"display-height": 0,
					"freq": 7100000,
					"mode": 0 ,
					"filter": 0 ,
					"agc": 0 ,
					"attn": 0 ,
					"hf-preamp": 0 ,
					"6m-preamp": 0 ,
					"audio-gain": 50
				} ]
			],
			[
				\ src						SoD
				false, [null, false, 
				{
					"display-width": 0,
					"display-height": 0,
					"freq": 7100000,
					"mode": 0 ,
					"filter": 0 ,
					"agc": 0 ,
					"attn": 0 ,
					"hf-preamp": 0 ,
					"6m-preamp": 0 ,
					"audio-gain": 50
				} ]
			],
			[
				\ src						SoD
				false, [null, false, 
				{
					"display-width": 0,
					"display-height": 0,
					"freq": 7100000,
					"mode": 0 ,
					"filter": 0 ,
					"agc": 0 ,
					"attn": 0 ,
					"hf-preamp": 0 ,
					"6m-preamp": 0 ,
					"audio-gain": 50
				} ]
			]
		]
	} var, struct1
	
: callback_wd_1	\ data
	\ "wd_1: " t:name@ s:+ " : " s:+ . . cr ;
	drop "1:" . ;

: callback_wd_2	\ data
	\ "wd_2: " t:name@ s:+ " : " s:+ . . cr ;
	drop "2:" . ;

: callback_wd_3	\ data
	\ "wd_3: " t:name@ s:+ " : " s:+ . . cr ;
	drop "3:" . ;
	
: callback_wd_4	\ data
	\ "wd_4: " t:name@ s:+ " : " s:+ . . cr ;
	drop "4:" . ;
	
: setup
	\ Subscribe to events
	UI_SMPL_RATE ' callback_wd_1 pubsub_subscribe
	UI_NUM_RX ' callback_wd_1 pubsub_subscribe
	UI_BLK_SZ ' callback_wd_1 pubsub_subscribe
	UI_INPUT_SRC ' callback_wd_1 pubsub_subscribe
	UI_OUTPUT_SINK ' callback_wd_1 pubsub_subscribe
	SYS_SMPL_RATE ' callback_wd_1 pubsub_subscribe
	SYS_NUM_RX ' callback_wd_1 pubsub_subscribe
	SYS_BLK_SZ ' callback_wd_1 pubsub_subscribe
	SYS_INPUT_SRC ' callback_wd_1 pubsub_subscribe
	SYS_INPUT_DEV ' callback_wd_1 pubsub_subscribe
	
	UI_SMPL_RATE ' callback_wd_2 pubsub_subscribe
	UI_NUM_RX ' callback_wd_2 pubsub_subscribe
	UI_BLK_SZ ' callback_wd_2 pubsub_subscribe
	UI_INPUT_SRC ' callback_wd_2 pubsub_subscribe
	UI_OUTPUT_SINK ' callback_wd_2 pubsub_subscribe
	SYS_SMPL_RATE ' callback_wd_2 pubsub_subscribe
	SYS_NUM_RX ' callback_wd_2 pubsub_subscribe
	SYS_BLK_SZ ' callback_wd_2 pubsub_subscribe
	SYS_INPUT_SRC ' callback_wd_2 pubsub_subscribe
	SYS_INPUT_DEV ' callback_wd_2 pubsub_subscribe
	
	UI_SMPL_RATE ' callback_wd_3 pubsub_subscribe
	UI_NUM_RX ' callback_wd_3 pubsub_subscribe
	UI_BLK_SZ ' callback_wd_3 pubsub_subscribe
	UI_INPUT_SRC ' callback_wd_3 pubsub_subscribe
	UI_OUTPUT_SINK ' callback_wd_3 pubsub_subscribe
	SYS_SMPL_RATE ' callback_wd_3 pubsub_subscribe
	SYS_NUM_RX ' callback_wd_3 pubsub_subscribe
	SYS_BLK_SZ ' callback_wd_3 pubsub_subscribe
	SYS_INPUT_SRC ' callback_wd_3 pubsub_subscribe
	SYS_INPUT_DEV ' callback_wd_3 pubsub_subscribe
	
	UI_SMPL_RATE ' callback_wd_4 pubsub_subscribe
	UI_NUM_RX ' callback_wd_4 pubsub_subscribe
	UI_BLK_SZ ' callback_wd_4 pubsub_subscribe
	UI_INPUT_SRC ' callback_wd_4 pubsub_subscribe
	UI_OUTPUT_SINK ' callback_wd_4 pubsub_subscribe
	SYS_SMPL_RATE ' callback_wd_4 pubsub_subscribe
	SYS_NUM_RX ' callback_wd_4 pubsub_subscribe
	SYS_BLK_SZ ' callback_wd_4 pubsub_subscribe
	SYS_INPUT_SRC ' callback_wd_4 pubsub_subscribe
	SYS_INPUT_DEV ' callback_wd_4 pubsub_subscribe
;

\ Runs longer with sleeps
: do_publish	
	\ Publish events using struct_manip to extract values from the test structures
	UI_SMPL_RATE struct @ ["general","blksz",1,2] val@ pubsub_publish
	UI_NUM_RX struct @ ["general","smplrate",1,2] ["general","smplrate",1,0] idx_val@ pubsub_publish
	UI_BLK_SZ struct @ ["general","blksz",1,2] val@ pubsub_publish
	0.2 sleep
	UI_INPUT_SRC struct @ ["general","blksz",1,2] val@ pubsub_publish
	UI_OUTPUT_SINK struct @ ["general","numrx",1,0] val@ pubsub_publish
	SYS_SMPL_RATE struct @ ["general","blksz",1,2] val@ pubsub_publish
	0.2 sleep
	SYS_NUM_RX struct @ ["general","blksz",1,2] val@ pubsub_publish
	SYS_BLK_SZ struct @ ["general","blksz",1,2] val@ pubsub_publish
	SYS_INPUT_SRC [0, false, ["48000", "96000", "192000"]] [2] [0] idx_val@  pubsub_publish
	SYS_INPUT_DEV [0, false, ["48000", "96000", "192000"]] [2] [0] idx_val@  pubsub_publish
	0.2 sleep
;

: runtest
	cr cr "Run test: " . . cr cr
	do_publish 
	0.2 sleep ;

setup	
1 sleep
' runtest 1 5000 loop
pubsub_term

\ Wait for all tasks to complete
wait_all

\ Reset namespace
ns: user

\ allow log to flush...
0.2 sleep
bye

